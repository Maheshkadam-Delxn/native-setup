import * as React from 'react';
import { useState } from 'react';
import {
  GridColDef,
  GridSortModel,
  GridPaginationModel,
  GridFilterModel,
} from '@mui/x-data-grid';
import { 
  Container, 
  Header, 
  CreateButton,
  StatusIndicator,
  TabContainer,
  TabItem,
  TabContent
} from './styles';
import Tooltip from '@mui/material/Tooltip';
import { mocksourceGridRows } from '../../mockData/sourceGrid.mock';
import {
  defaultPagesizeOptions,
  defaultSortingMode,
  defaultFilterMode,
} from '../../shared/datagridDefaults';
import CustomElementModal from '@/components/CommonModal/CustomElementModal';
import NewChildForm from '../childSource/page';
import Applayout from '@/components/appLayout/page';
import LayoutProperties from '../../mockData/appLayoutProps';
import { useSampleData } from '@/mockData/useSampleData';
import useColumns from '@/hooks/useColumn';
import { DataGridComponent } from '@/components/DataGrid';
import SourceDetails from '../sourceDetails/page';
import { Chip, Box, Typography, useTheme } from '@mui/material';

const renderCellWithTooltip = (params: any) => {
  return (
    <Tooltip
      title={<span style={{ userSelect: 'text' }}>{params.value}</span>}
      enterTouchDelay={0}
      leaveTouchDelay={5000}
      enterDelay={300}
      leaveDelay={300}
      placement="top"
      PopperProps={{
        modifiers: [{ name: 'offset', options: { offset: [0, -25] } }],
      }}
    >
      <span
        style={{
          whiteSpace: 'nowrap',
          overflow: 'hidden',
          textOverflow: 'ellipsis',
          display: 'inline-block',
          width: '100%',
          userSelect: 'text',
          cursor: 'text',
        }}
      >
        {params.value}
      </span>
    </Tooltip>
  );
};

const statusColors = {
  active: '#4caf50',
  pending: '#ff9800',
  inactive: '#f44336',
  draft: '#9e9e9e',
};

const SourceGrid: React.FC = () => {
  const theme = useTheme();
  const [paginationModel, setPaginationModel] = useState<GridPaginationModel>({
    pageSize: defaultPagesizeOptions[0],
    page: 0,
  });
  const [sortModel, setSortModel] = useState<GridSortModel>([]);
  const [modalOpen, setModalOpen] = useState(false);
  const [modalTitle, setModalTitle] = useState<string>('Add New Child');
  const [sourceParentLink, setParentLink] = useState<string>('');
  const [selectedSource, setSelectedSource] = useState<{
    id: string;
    name: string;
    status: 'active' | 'inactive' | 'pending';
  } | null>(null);
  const [activeTab, setActiveTab] = useState('sources');
  const { sampleData } = useSampleData();
  const { policyDetailVersionHistoryColumns } = useColumns();
  const [isCreateNewParent, setIsCreateNewParent] = useState(false);
  const [versionPagination, setVersionPagination] = useState<GridPaginationModel>({
    pageSize: defaultPagesizeOptions[0],
    page: 0,
  });
  const [versionSortModel, setVersionSortModel] = useState<GridSortModel>([]);
  const [versionFilterModel, setVersionFilterModel] = useState<GridFilterModel>({
    items: [],
  });

  const handleCreateNewParent = () => {
    setModalTitle('Create New Parent');
    setParentLink('');
    setIsCreateNewParent(true);
    setModalOpen(true);
  };

  const columns: GridColDef[] = [
    {
      field: 'actions',
      headerName: '',
      width: 160,
      sortable: false,
      filterable: false,
      disableColumnMenu: true,
      renderCell: ({ row }) => {
        const handleNewChildClick = () => {
          setModalTitle('Add New Child');
          setParentLink(row.link.toString());
          setIsCreateNewParent(false);
          setModalOpen(true);
        };
        return (
          <div style={{ display: 'flex', gap: '8px' }}>
            <span style={{ color: '#1976d2', cursor: 'pointer' }}>
              <u>View Latest</u>
            </span>
            {row.showNewChild && (
              <div>
                &nbsp;&nbsp;
                <span style={{ color: '#1976d2', cursor: 'pointer' }}>
                  <u>
                    <a
                      href="#"
                      onClick={(e) => {
                        e.preventDefault();
                        handleNewChildClick();
                      }}
                    >
                      New Child
                    </a>
                  </u>
                </span>
              </div>
            )}
          </div>
        );
      },
    },
    {
      field: 'linkName',
      headerName: 'Link Name',
      flex: 1,
      renderCell: renderCellWithTooltip,
      filterable: true,
    },
    {
      field: 'link',
      headerName: 'Link',
      flex: 2,
      renderCell: renderCellWithTooltip,
      filterable: true,
    },
    { 
      field: 'linkType', 
      headerName: 'Link Type', 
      flex: 1, 
      filterable: true 
    },
    {
      field: 'linkStatus',
      headerName: 'Status',
      flex: 1,
      filterable: true,
      renderCell: (params) => (
        <Chip
          label={params.value}
          style={{
            backgroundColor: statusColors[params.value.toLowerCase()] || '#e0e0e0',
            color: '#fff',
            fontWeight: 'bold',
            textTransform: 'capitalize',
          }}
        />
      ),
    },
    {
      field: 'scheduledType',
      headerName: 'Scheduled Type',
      flex: 1,
      filterable: true,
    },
    { 
      field: 'createdOn', 
      headerName: 'Created On', 
      flex: 1, 
      filterable: true 
    },
    {
      field: 'lastUpdated',
      headerName: 'Last Updated',
      flex: 1,
      filterable: true,
    },
    {
      field: 'lastUpdatedBy',
      headerName: 'Last Updated By',
      flex: 1,
      filterable: true,
    },
  ];

  const versionTooltipColumns = ['link', 'linkName', 'versionNotes'];

  const versionHistoryGridColumns: GridColDef[] =
    policyDetailVersionHistoryColumns.map((col) => {
      const baseCol: GridColDef = {
        field: col.id,
        headerName: col.label,
        flex: 1,
        sortable: col.filter !== false,
        filterable: col.filter !== false,
        renderCell: (params) => {
          if (versionTooltipColumns.includes(col.id)) {
            return (
              <Tooltip title={params.value || '-'} placement="top-start" arrow>
                <span
                  style={{
                    cursor: 'pointer',
                    overflow: 'hidden',
                    textOverflow: 'ellipsis',
                    whiteSpace: 'nowrap',
                  }}
                >
                  {params.value || '-'}
                </span>
              </Tooltip>
            );
          }
          return params.value || '-';
        },
      };
      if (col.width) baseCol.width = col.width;
      if (col.flex) baseCol.flex = col.flex;
      if (col.minWidth) baseCol.minWidth = col.minWidth;
      if (col.maxWidth) baseCol.maxWidth = col.maxWidth;
      return baseCol;
    });

  const tabs = [
    { label: 'Policies', value: 'sources' },
    { label: 'Details', value: 'details', disabled: !selectedSource },
    {
      label: 'Version History',
      value: 'versionHistory',
      disabled: !selectedSource,
    },
    {
      label: 'Notifications History',
      value: 'notificationHistory',
      disabled: !selectedSource,
    },
    { label: 'History', value: 'history', disabled: !selectedSource },
  ];

  const handleRowSelectionChange = (
    newSelectedRowId: string | null,
    rowData?: any
  ) => {
    if (newSelectedRowId && rowData) {
      setSelectedSource({ 
        id: newSelectedRowId, 
        name: rowData.linkName,
        status: rowData.linkStatus.toLowerCase()
      });
    } else {
      setSelectedSource(null);
    }
  };

  const handleTabChange = (value: string) => {
    const tab = tabs.find((t) => t.value === value);
    if (tab?.disabled) return;
    setActiveTab(value);
  };

  const tabPanels: Record<string, React.ReactNode> = {
    sources: (
      <>
        <DataGridComponent
          rows={mocksourceGridRows}
          columns={columns}
          paginationModel={paginationModel}
          onPaginationModelChange={setPaginationModel}
          sortModel={sortModel}
          onSortModelChange={setSortModel}
          sortingMode={defaultSortingMode}
          filterMode={defaultFilterMode}
          pageSizeOptions={defaultPagesizeOptions}
          selectedRowId={selectedSource?.id || null}
          onRowSelectionChange={handleRowSelectionChange}
        />
        <CustomElementModal
          open={modalOpen}
          title={modalTitle}
          ContentComponent={NewChildForm}
          contentProps={{
            parentLink: isCreateNewParent ? '' : sourceParentLink,
            linkType: isCreateNewParent ? 'Parent' : 'child',
            isCreateNewParent: `${isCreateNewParent}`,
            onCancelConfirmed: () => setModalOpen(false),
          }}
          onClose={() => setModalOpen(false)}
          large
        />
      </>
    ),
    details: selectedSource ? (
      <SourceDetails sourceId={Number(selectedSource.id)} />
    ) : null,
    versionHistory: (
      <DataGridComponent
        columns={versionHistoryGridColumns}
        rows={sampleData}
        paginationModel={versionPagination}
        onPaginationModelChange={setVersionPagination}
        sortModel={versionSortModel}
        onSortModelChange={setVersionSortModel}
        filterModel={versionFilterModel}
        onFilterModelChange={setVersionFilterModel}
        sortingMode={defaultSortingMode}
        filterMode={defaultFilterMode}
        pageSizeOptions={defaultPagesizeOptions}
        getRowId={(row) => row.id?.toString() || Math.random().toString()}
        disableRowSelectionOnClick
      />
    ),
    notificationHistory: selectedSource ? (
      <Box sx={{ p: 3 }}>
        <Typography variant="h6" gutterBottom>
          Notification History for {selectedSource.name}
        </Typography>
        <Box sx={{ display: 'flex', gap: 2, mb: 2 }}>
          <StatusIndicator color={statusColors[selectedSource.status]} />
          <Typography>
            Status: <strong>{selectedSource.status.toUpperCase()}</strong>
          </Typography>
        </Box>
        <Typography>
          <strong>Source ID:</strong> {selectedSource.id}
        </Typography>
      </Box>
    ) : (
      <Box sx={{ p: 3, textAlign: 'center' }}>
        <Typography variant="body1" color="textSecondary">
          Please select a row to see Notification History
        </Typography>
      </Box>
    ),
    history: selectedSource ? (
      <Box sx={{ p: 3 }}>
        <Typography variant="h6" gutterBottom>
          History for {selectedSource.name}
        </Typography>
        <Box sx={{ display: 'flex', gap: 2, mb: 2 }}>
          <StatusIndicator color={statusColors[selectedSource.status]} />
          <Typography>
            Status: <strong>{selectedSource.status.toUpperCase()}</strong>
          </Typography>
        </Box>
        <Typography>
          <strong>Source ID:</strong> {selectedSource.id}
        </Typography>
      </Box>
    ) : (
      <Box sx={{ p: 3, textAlign: 'center' }}>
        <Typography variant="body1" color="textSecondary">
          Please select a row to see History
        </Typography>
      </Box>
    ),
  };

  return (
    <AppLayout {...LayoutProperties}>
      <Container>
        <Header>
          <CreateButton 
            onClick={handleCreateNewParent}
            variant="contained"
            color="primary"
          >
            Create New Parent
          </CreateButton>
        </Header>
        
        <TabContainer>
          {tabs.map((tab) => (
            <TabItem
              key={tab.value}
              active={activeTab === tab.value}
              disabled={tab.disabled}
              onClick={() => handleTabChange(tab.value)}
            >
              {tab.label}
            </TabItem>
          ))}
        </TabContainer>
        
        <TabContent>
          {tabPanels[activeTab]}
        </TabContent>
      </Container>
    </AppLayout>
  );
};

export default SourceGrid;






































import styled from '@emotion/styled';
import { Button } from '@mui/material';

export const Container = styled.div`
  display: flex;
  flex-direction: column;
  height: 100%;
  padding: 24px;
  gap: 16px;
`;

export const Header = styled.div`
  display: flex;
  justify-content: flex-end;
  margin-bottom: 16px;
`;

export const CreateButton = styled(Button)`
  text-transform: none;
  font-weight: 600;
  padding: 8px 16px;
`;

export const StatusIndicator = styled.div<{ color: string }>`
  width: 12px;
  height: 12px;
  border-radius: 50%;
  background-color: ${({ color }) => color};
`;

export const TabContainer = styled.div`
  display: flex;
  border-bottom: 1px solid #e0e0e0;
  margin-bottom: 16px;
`;

export const TabItem = styled.div<{ active: boolean; disabled?: boolean }>`
  padding: 12px 24px;
  cursor: ${({ disabled }) => (disabled ? 'not-allowed' : 'pointer')};
  border-bottom: 2px solid ${({ active }) => (active ? '#1976d2' : 'transparent')};
  color: ${({ active, disabled }) => 
    disabled ? '#bdbdbd' : active ? '#1976d2' : '#424242'};
  font-weight: ${({ active }) => (active ? '600' : '400')};
  opacity: ${({ disabled }) => (disabled ? 0.6 : 1)};
  transition: all 0.2s ease;
  position: relative;
  display: flex;
  align-items: center;
  background-color: ${({ active }) => (active ? 'rgba(25, 118, 210, 0.08)' : 'transparent')};

  &:hover {
    background-color: ${({ disabled }) => (disabled ? 'transparent' : '#f5f5f5')};
  }

  ${({ disabled }) => disabled && `
    text-decoration: line-through;
    text-decoration-color: rgba(0, 0, 0, 0.3);
    text-decoration-thickness: 1px;
  `}
`;

export const TabContent = styled.div`
  flex: 1;
  overflow: auto;
  background: #fff;
  border-radius: 4px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
`;
